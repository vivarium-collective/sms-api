services:
  api:
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile-sms
    image: sms-api:latest
    container_name: api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # the nats image locally listens on 4222
      NATS_URL: "nats://nats:4222"
      NATS_EMITTER_URL: "nats://nats:4222"
      HPC_SIM_CONFIG_FILE: publish.json
      NATS_WORKER_EVENT_SUBJECT: test.ecoli-publish
    networks:
      - smsnet
    volumes:
      - ./sms_api:/app/sms_api
    command: >
      uv run uvicorn sms_api.api.main:app
      --host 0.0.0.0
      --port 8000
      --reload

  nats:
    image: nats:latest
    container_name: nats
    ports:
      - "30050:4222"   # map container port 4222 to host port 30050
      - "8222:8222"    # optional: monitoring port
    networks:
      - smsnet

networks:
  smsnet:
    driver: bridge
